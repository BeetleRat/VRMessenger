@mainpage Многопользовательский интерфейс для общения в виртуальной реальности с использованием аватаров

@tableofcontents

@section section_water Общее описание работы скриптов
Основным скриптом является NetworkManager. В нем осуществляется подключение к серверу, отключение от сервера, создание и подключение к лобби, создание и подключение к комнате, отключение от комнаты, отключение от лобби, отключение от сервера, спавн игрока на сервере. В полях данного скрипта указываются типы доступных комнат, а также имя prefab-а игрока спавнемого на сервере. Данный prefab должен храниться в папке Resources в корне проекта.

Скрипту NetworkManager необходимо загружать различные сцены. Для этой цели ему передается скрипт SceneChanger, отвечающий за смену сцен.

В процессе работы приложения регулярно необходимо будет синхронизировать состояния объектов с сервером. Для отправки текущего состояния на сервер, а также обработки пришедших на сервер состояний используется скрипт NetworkVariables.

Для отладки приложения необходимо логгировать отлаживаемые компоненты. При разработке не всегда удобно, а иногда и невозможно смотреть в консоль движка Unity. С этой целью был написан скрипт VRLogger, выводящий приходящие в него логи на текстовое поле интерфейса внутри приложения. Таких скриптов в сцене может быть много. Мы можем дать каждому игроку по экрану лога. Что бы при логгировании не искать каждый раз все VRLogger в сцене, был написан скрипт VRLoggersManager. VRLoggersManager выводит лог во все VRLogger на сцене.

Игрок может переключаться между типами контроллеров. Он может осуществлять взаимодействие с виртуальной реальностью при помощи контроллеров Oculus Touch, а может отложить их в сторону и начать взаимодействовать при помощи своих собственных рук. Подобное переключение необходимо отслеживать. Это нужно как для корректного отображения типа контроллеров на сервере, так и для использования корректных якорей на теле игрока. С целью отслеживания данного переключения создан скрипт ControllerEvents.

Скрипты NetworkManager, SceneChanger, NetworkVariables, VRLoggersManager, ControllerEvents должны всегда оставаться в сцене, и более того, при смене сцены они должны сохранять свое состояние. Для этого к ним применен паттерн Singleton, реализованный в скрипте EasySingleton.

NetworkManager при подключении к комнате спавнит на сервере prefab игрока, который он берет из папки Resources в корне проекта. Рассмотрим данный prefab:
\image html PlayerPrefab.png width=500
<div style="text-align: center;">
    Prefab спавнемого игрока
</div>


Данный prefab имеет голову, левую и правую руки. 

Голова состоит из модели головы и компонента Speaker, отвечающего за передачу голоса на сервер.

В руках храниться компонент ControllerTypeController, отвечающий за смету типа отображаемых на сервере контроллеров. Внутри этого компонента хранятся отображаемые контроллеры: Controller и Hand. Controller управляется скриптом ControllerAnimationUpdater. Этот скрипт осуществляет синхронизацию анимации контроллера, отображаемого локально и контроллера, отображаемого на сервере. Hand, в свою очередь, управляется скриптом GostHandTransformUpdater. Данный скрипт синхронизирует положение и поворот всех суставов отображаемой на сервере руки и HandSynthetic локального игрока.

Весь prefab игрока контролируется скриптом NetworkPlayer, который обеспечивает синхронизацию положения контроллеров/рук и головы игрока локального и отображения этих частей на сервере. Так же данный скрипт следит за синхронизацией состояния типа контроллеров. 

Если NetworkPlayer работает на стороне сервера, то на стороне клиента присутствует компонент HandView, к которому NetworkPlayer обращается за текущим положением и состоянием рук.

HandView должен быть прикреплен к рукам локального игрока, чтобы корректно передавать их положение на сервер. Причем при смене типа контроллера он должен перепрыгивать с рук на контроллеры и наоборот. Вручную размещать данные компоненты на игроке неудобно. А потому был написан скрипт AttachToPlayersBody. Данный скрипт прикрепляет компонент к якорю, указанному в его свойствах. Таким образом, мы создаем якорь на руках и контроллерах, а скрипт AttachToPlayersBody во время запуска игры крепит к данным якорям указанный компонент. Это позволяет хранить все прикрепляемые к игроку объекты в отдельном месте, а prefab игрока открывать только для настроек игрока и добавления якорей.

В лобби присутствуют UI кнопки, которые должны обращаться к NetworkManager, но NetworkManager нельзя добавлять в OnClick события, т.к. после смены сцен, в лобби вернется текущий NetworkManager, а указанный в изначальной сцене будет уничтожен. С целью исправить это, а так же предоставить кнопкам удобный интерфейс взаимодействия с NetworkManager через OnClick события, был создан компонент NetworkManagerProvider.

Развивая идеи NetworkManagerProvider, появился компонент ComponentCatcher. В сцене могут появляться объекты изначально там не находящиеся. Это singleton объекты пришедшие из другой сцены, спавнемые аватары или просто объекты. И всем им могут быть нужны различные объекты из текущей сцены. ComponentCatcher это компонент, настраиваемый instance которого находиться в каждой сцене. Данный компонент при старте сцены отлавливает все часто используемые объекты и объекты, до которых не добраться во время редактирования сцены: VRLoggersManager, NetworkManager, ControllerEvents и подобные. В дальнейшем, если какому-либо скрипту понадобиться NetworkManager, он обратиться за ним к ComponentCatcher.

При взаимодействии игрока с предметами возникал ряд ошибок, следующие скрипты были написаны для исправления данных ошибок:
- IgnoreGrabbableObjects – исправление ошибки, из-за которой коллайдер взятого объекта сталкивался с коллайдером игрока, и игрок двигал сам себя.
- OwnershipTransfer - В Photon у интерактивных объектов есть владелец. И Photon синхронизирует с сервером только данные владельца объекта. Владельцем становится первый схвативший объект. Но нам необходимо, что бы все пользователи могли взаимодействовать с объектами. Для этого необходимо передавать владение объектом тому пользователю, который взял объект. OwnershipTransfer совершает передачу прав владения объектом тому, кто взял этот объект.
- RigidBodySycn – Photon синхронизирует положение, скорость, ускорение объекта. Но не синхронизирует isKinematic. Из-за чего происходит ошибка: когда игрок берет предмет, локально, данный предмет становиться Kinematic, а на сервере получается, что объект поднят в воздух и он начинает падать, пока Photon снова не синхронизирует его положение. Из-за данной ошибки взятый в руку предмет начинает прыгать в руку и вниз. RigidBodySycn синхронизирует isKinematic объекта с сервером и исправляет данную ошибку.

Взаимодействие с микрофоном осуществляется скриптами MicrophoneController и MicrophoneNetworkSettings. MicrophoneController контролирует локальные действия с микрофоном, а MicrophoneNetworkSettings отвечает за синхронизацию локальных действий на сервере.

В некоторых сценах играет фоновая музыка. Она может отвлекать или просто не нравиться пользователю. Для контроля нескольких источников звука, в частности фоновой музыки, используется скрипт AudioController.

В лобби состояние главного меню должно изменяться в зависимости от текущего состояния подключения к серверу. Например, пока происходит подключение меню должно отображать preloader, а когда подключение завершилось скрыть его и показать пункты меню. За динамическую смену слоев интерфейса главного меню в зависимости от сигналов приходящих от NetworkManager, отвечает компонент ChangeUILayer.

При выборе комнаты игроку должен предоставляться список комнат активных в данный момент. Этот список реализуется скриптами RoomListItem – элемент списка, и UIRoomListController – непосредственно список отрисовывающий RoomListItem в UI.

У игрока на запястье присутствует несколько меню. Эти меню не всегда включены и когда одно меню становится видимым, предыдущее исчезает. Для скрытия/появления меню используется скрипт InterfaceHider. А для смены одного меню на другое используется скрипт MenuSwapper.

Для распознавания жестов используется абстрактный класс GestureDetector. Его наследники могут отслеживать жесты и осуществлять действия при их обнаружении.

Компонент GestureProperties хранит в себе информацию о пальцах загнутых в указанном жесте.

Вспомогательные маленькие скрипты:
- ButtonTextChanger – при наведении на UI кнопку записывает в указанное текстовое поле указанный текст;
- GifAnimation – создает анимацию из входных кадров;
- SetupRoomName – записывает имя текущей комнаты в указанное текстовое поле.


@section section1 Скрипты для работы с сетью

- NetworkManager;
- NetworkPlayer;
- ComponentCatcher;
- NetworkVariables;
- OwnershipTransfer;
- RigidBodySycn;
- NetworkManagerProvider;

@section section2 Скрипты для работы с компонентами

- ControllerModel;
- ControllerAnimationUpdater;
- HandsAnimaionUpdater;
- GostHandTransformUpdater;
- MicrophoneController;
- MicrophoneNetworkSettings;
- AudioController;
- ControllerTypeController;
- ControllerEvents;
- AttachToPlayersBody;
- HandView;
- EasySingleton;
- IgnoreGrabbableObjects;

@section section3 Скрипты для работы с жестами

- GestureDetector;
- GestureAnimation;
- GestureProperties;

@section section4 Скрипты для работы с UI

- ChangeUILayer;
- ButtonTextChanger;
- UIRoomListController;
- GifAnimation;
- RoomListItem;
- SetupRoomName;
- InterfaceHider;
- MenuSwapper;
- VRLogger;
- VRLoggersManager;

@section section5 Прочие скрипты

- SceneChanger